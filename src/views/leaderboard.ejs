<% layout('home_layout.ejs') %>
<link rel="stylesheet" href="/css/dashboard.css">

<div class="leaderboard-page">
  <h2 class="text-center mb-4">üèÜ FindMrWhite Leaderboard</h2>
  
  <div class="leaderboard-stats mb-4">
    <div class="row">
      <div class="col-md-4 text-center">
        <div class="stat-card">
          <h4>Most Games Played</h4>
          <% if (leaderboard && leaderboard.length > 0) { %>
            <% const mostGames = leaderboard.reduce((max, p) => p.stats.gamesPlayed > max.stats.gamesPlayed ? p : max) %>
            <p class="stat-value"><%= mostGames.username %></p>
            <p class="stat-detail"><%= mostGames.stats.gamesPlayed %> games</p>
          <% } %>
        </div>
      </div>
      <div class="col-md-4 text-center">
        <div class="stat-card">
          <h4>Most Wins</h4>
          <% if (leaderboard && leaderboard.length > 0) { %>
            <% const mostWins = leaderboard[0] %>
            <p class="stat-value"><%= mostWins.username %></p>
            <p class="stat-detail"><%= mostWins.stats.wins %> wins</p>
          <% } %>
        </div>
      </div>
      <div class="col-md-4 text-center">
        <div class="stat-card">
          <h4>Best Win Rate</h4>
          <% if (leaderboard && leaderboard.length > 0) { %>
            <% const bestRate = leaderboard.filter(p => p.stats.gamesPlayed >= 5)
                                          .reduce((max, p) => p.stats.winRate > max.stats.winRate ? p : max, {stats: {winRate: 0}}) %>
            <% if (bestRate.username) { %>
              <p class="stat-value"><%= bestRate.username %></p>
              <p class="stat-detail"><%= bestRate.stats.winRate %>%</p>
            <% } else { %>
              <p class="stat-detail">Min 5 games required</p>
            <% } %>
          <% } %>
        </div>
      </div>
    </div>
  </div>
  
  <div class="leaderboard-table-container">
    <% if (leaderboard && leaderboard.length > 0) { %>
      <table class="table table-dark table-striped table-hover">
        <thead>
          <tr>
            <th class="text-center">Rank</th>
            <th>Player</th>
            <th class="text-center">Games</th>
            <th class="text-center">Wins</th>
            <th class="text-center">Losses</th>
            <th class="text-center">Win Rate</th>
            <th class="text-center">Survived</th>
            <th class="text-center">Eliminated</th>
            <th class="text-center" colspan="3">Role Breakdown</th>
          </tr>
          <tr>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th></th>
            <th class="text-center sub-header">Civilian</th>
            <th class="text-center sub-header">Undercover</th>
            <th class="text-center sub-header">Mr. White</th>
          </tr>
        </thead>
        <tbody>
          <% leaderboard.forEach((player, index) => { %>
            <tr class="<%= index < 3 ? 'top-player' : '' %> player-row">
              <td class="text-center rank-cell">
                <% if (index === 0) { %>
                  <span class="rank-medal">ü•á</span>
                <% } else if (index === 1) { %>
                  <span class="rank-medal">ü•à</span>
                <% } else if (index === 2) { %>
                  <span class="rank-medal">ü•â</span>
                <% } else { %>
                  <span class="rank-number"><%= index + 1 %></span>
                <% } %>
              </td>
              <td class="username-cell">
                <strong><%= player.username %></strong>
              </td>
              <td class="text-center">
                <span class="stat-badge"><%= player.stats.gamesPlayed %></span>
              </td>
              <td class="text-center">
                <span class="wins-badge"><%= player.stats.wins %></span>
              </td>
              <td class="text-center">
                <span class="losses-badge"><%= player.stats.losses %></span>
              </td>
              <td class="text-center">
                <span class="win-rate <%= player.stats.winRate >= 50 ? 'high-win-rate' : 'low-win-rate' %>">
                  <%= player.stats.winRate %>%
                </span>
              </td>
              <td class="text-center">
                <span class="survived-badge"><%= player.stats.survivedCount %></span>
              </td>
              <td class="text-center">
                <span class="eliminated-badge"><%= player.stats.eliminatedCount %></span>
              </td>
              <td class="text-center">
                <div class="role-stat">
                  <span class="role-games"><%= player.stats.gamesAsCivilian %></span>
                  <span class="role-wins civilian-wins"><%= player.stats.winsAsCivilian %>W</span>
                </div>
              </td>
              <td class="text-center">
                <div class="role-stat">
                  <span class="role-games"><%= player.stats.gamesAsUndercover %></span>
                  <span class="role-wins undercover-wins"><%= player.stats.winsAsUndercover %>W</span>
                </div>
              </td>
              <td class="text-center">
                <div class="role-stat">
                  <span class="role-games"><%= player.stats.gamesAsMrWhite %></span>
                  <span class="role-wins mrwhite-wins"><%= player.stats.winsAsMrWhite %>W</span>
                </div>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    <% } else { %>
      <div class="alert alert-info text-center">
        <h4>No games have been completed yet!</h4>
        <p>Be the first to play and claim the top spot on the leaderboard.</p>
        <a href="/dashboard" class="btn btn-primary">Start Playing</a>
      </div>
    <% } %>
  </div>
  
  <div class="text-center mt-4">
    <a href="/dashboard" class="btn btn-secondary">Back to Dashboard</a>
  </div>
</div>

<style>
.leaderboard-page {
  max-width: 1400px;
  margin: 0 auto;
  padding: 20px;
}

.leaderboard-stats {
  margin-bottom: 30px;
}

.stat-card {
  background: rgba(0, 0, 0, 0.8);
  border-radius: 10px;
  padding: 20px;
  margin-bottom: 20px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.stat-value {
  font-size: 1.5em;
  font-weight: bold;
  color: #ffc107;
  margin: 10px 0;
}

.stat-detail {
  font-size: 1.1em;
  color: #ccc;
}

.leaderboard-table-container {
  background: rgba(0, 0, 0, 0.7);
  border-radius: 10px;
  padding: 20px;
  overflow-x: auto;
}

.sub-header {
  font-size: 0.9em;
  font-weight: normal;
  color: #aaa;
  border-top: none !important;
}

.player-row:hover {
  background-color: rgba(255, 255, 255, 0.05);
  transform: translateX(5px);
  transition: all 0.3s ease;
}

.rank-medal {
  font-size: 2em;
}

.rank-number {
  font-size: 1.2em;
  font-weight: bold;
}

.username-cell {
  font-size: 1.2em;
}

.stat-badge {
  background: rgba(108, 117, 125, 0.3);
  padding: 5px 10px;
  border-radius: 5px;
}

.wins-badge {
  background: rgba(40, 167, 69, 0.3);
  color: #28a745;
  padding: 5px 10px;
  border-radius: 5px;
  font-weight: bold;
}

.losses-badge {
  background: rgba(220, 53, 69, 0.3);
  color: #dc3545;
  padding: 5px 10px;
  border-radius: 5px;
}

.survived-badge {
  background: rgba(23, 162, 184, 0.3);
  color: #17a2b8;
  padding: 5px 10px;
  border-radius: 5px;
}

.eliminated-badge {
  background: rgba(255, 193, 7, 0.3);
  color: #ffc107;
  padding: 5px 10px;
  border-radius: 5px;
}

.win-rate {
  padding: 5px 10px;
  border-radius: 5px;
  font-weight: bold;
}

.high-win-rate {
  background: rgba(40, 167, 69, 0.4);
  color: #28a745;
}

.low-win-rate {
  background: rgba(220, 53, 69, 0.4);
  color: #dc3545;
}

.role-stat {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 5px;
}

.role-games {
  color: #aaa;
  font-size: 0.9em;
}

.role-wins {
  padding: 2px 6px;
  border-radius: 3px;
  font-size: 0.85em;
  font-weight: bold;
}

.civilian-wins {
  background: rgba(0, 123, 255, 0.3);
  color: #007bff;
}

.undercover-wins {
  background: rgba(255, 193, 7, 0.3);
  color: #ffc107;
}

.mrwhite-wins {
  background: rgba(220, 53, 69, 0.3);
  color: #dc3545;
}

/* Animations */
.stat-card {
  animation: slideIn 0.5s ease-out;
}

.player-row {
  animation: fadeIn 0.3s ease-out;
  animation-fill-mode: both;
}

.player-row:nth-child(1) { animation-delay: 0.1s; }
.player-row:nth-child(2) { animation-delay: 0.2s; }
.player-row:nth-child(3) { animation-delay: 0.3s; }
.player-row:nth-child(4) { animation-delay: 0.4s; }
.player-row:nth-child(5) { animation-delay: 0.5s; }

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateX(-20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

/* Top player effects */
.top-player {
  background: linear-gradient(90deg, 
    rgba(255, 215, 0, 0.1) 0%, 
    rgba(255, 215, 0, 0.05) 50%, 
    rgba(255, 215, 0, 0.1) 100%);
  position: relative;
}

.top-player:before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(90deg, 
    transparent 0%, 
    rgba(255, 215, 0, 0.1) 50%, 
    transparent 100%);
  animation: shimmer 3s infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}
</style>